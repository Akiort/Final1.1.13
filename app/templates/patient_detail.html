
{% extends "base.html" %}
{% block content %}
<a href="/expediente" class="muted">← Expediente</a>
<h1>{{ p.nombre }}</h1>
<p class="muted">Edad: {{ edad_calc or '—' }} • Sexo: {{ p.sexo or '—' }}{% if extra and extra.app %} • APP: {{ extra.app }}{% endif %}{% if extra and extra.cirugias_previas %} • Cirugías previas: {{ extra.cirugias_previas }}{% endif %}</p>

<section class="card">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Nueva consulta</h2>
    <a href="#previas" class="button" aria-label="Ir a consultas previas">Ver consultas previas ↓</a>
  </div>
  <form action="/consulta/guardar" method="post" class="form grid" style="grid-template-columns:260px 1fr; gap:16px;">
    <div>
      <input type="hidden" name="patient_id" value="{{ p.id }}">
      <label>Fecha y hora
        <input id="fechaAuto" type="datetime-local" name="fecha">
      </label>
      <div class="card" style="padding:12px;">
        <h3>Signos vitales</h3>
        <label>TA<input name="ta" value="120/80"></label>
        <label>FC<input name="fc" value="80 x min"></"></label>
        <label>FR<input name="fr" value="18 x min"></label>
        <label>Peso<input name="peso" value="80 kg"></label>
        <label>Talla<input name="talla" value="1.70 m"></label>
      </div>
      <button class="primary">Guardar consulta</button>
      <a class="button" href="/receta/nueva/{{ p.id }}">Receta rápida →</a>
    </div>
    <div>
      <label>Padecimiento actual<textarea name="padecimiento_actual" rows="3"></textarea></label>
      <label>Exploración física<textarea name="exploracion_fisica" rows="3"></textarea></label>
      <label>Estudios complementarios<textarea name="estudios_complementarios" rows="2"></textarea></label>
      <div class="grid">
        <label>Diagnósticos<textarea name="diagnosticos" rows="2"></textarea></label>
        <label>Plan de manejo<textarea name="plan_manejo" rows="2"></textarea></label>
      </div>
      <label>Notas<textarea name="notas" rows="2"></textarea></label>
    </div>
  </form>
</section>

<section class="card" id="previas">
  <h2>Consultas previas</h2>
  {% if p.consultas %}
  <ul class="list">
    {% for c in p.consultas|sort(attribute='fecha', reverse=True) %}
      <li>
        <a href="/consulta/{{ c.id }}"><strong>{{ c.fecha.strftime('%d/%m/%Y %H:%M') }}</strong> — {{ c.dx or c.motivo or 'Consulta' }}</a>
      </li>
    {% endfor %}
  </ul>
  {% else %}
  <p class="muted">Sin consultas registradas.</p>
  {% endif %}
</section>

<script>
(function(){
  const el = document.getElementById('fechaAuto');
  if (el && !el.value){
    const now = new Date();
    const pad = n => n.toString().padStart(2,'0');
    el.value = now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+'T'+pad(now.getHours())+':'+pad(now.getMinutes());
  }
})();
</script>

{% endblock %}
